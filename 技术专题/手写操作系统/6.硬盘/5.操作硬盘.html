<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.50" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://noahyz.github.io/%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E6%89%8B%E5%86%99%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/6.%E7%A1%AC%E7%9B%98/5.%E6%93%8D%E4%BD%9C%E7%A1%AC%E7%9B%98.html"><meta property="og:site_name" content="noahyz的博客"><meta property="og:title" content="4.操作硬盘"><meta property="og:description" content="操作硬盘 如下为机械硬盘 一、硬盘相关概念 CPU 通过 IO 接口与硬盘通信，针对硬盘的 IO 接口是“硬盘控制器”。硬盘控制器和硬盘是连接在一起的，是专门驱动硬盘设备的模块电路。这种接口也称为集成设备电路（Integrated Drive Electronics，IDE）。后来，又将此接口使用的技术规范归纳成全球硬盘标准，于是产生了 ATA（Adv..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="noahyz"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"4.操作硬盘","image":[""],"dateModified":null,"author":[{"@type":"Person","name":"noahyz","url":"/about-the-author/"}]}</script><meta name="robots" content="all"><meta name="author" content="noahyz"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="keywords" content="Java, Java基础, 并发编程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, SpringBoot, IDEA, 求职面试, 面渣逆袭, 学习路线"><meta name="apple-mobile-web-app-capable" content="yes"><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?5230ac143650bf5eb3c14f3fb9b1d3ec";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      </script><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?59aa453e7e706422c636c079fc1cb031";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      </script><link rel="stylesheet" href="//at.alicdn.com/t/font_3180624_7cy10l7jqqh.css"><link rel="icon" href="/logo2.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#096dd9"><title>4.操作硬盘 | noahyz的博客</title><meta name="description" content="操作硬盘 如下为机械硬盘 一、硬盘相关概念 CPU 通过 IO 接口与硬盘通信，针对硬盘的 IO 接口是“硬盘控制器”。硬盘控制器和硬盘是连接在一起的，是专门驱动硬盘设备的模块电路。这种接口也称为集成设备电路（Integrated Drive Electronics，IDE）。后来，又将此接口使用的技术规范归纳成全球硬盘标准，于是产生了 ATA（Adv...">
    <link rel="preload" href="/assets/style-D4RaGlXo.css" as="style"><link rel="stylesheet" href="/assets/style-D4RaGlXo.css">
    <link rel="modulepreload" href="/assets/app-D1zlwylF.js"><link rel="modulepreload" href="/assets/5.操作硬盘.html-Dc5KrE36.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/./logo.png" alt><!----><span class="vp-site-name hide-in-pad">noahyz的博客</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="知识库"><!--[--><span class="font-icon icon iconfont icon-lujing" style=""></span><!--]-->知识库<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">编程语言</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">操作系统</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">计算机网络</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">技术专题</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">架构框架</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">分布式</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->4.操作硬盘</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="/about-the-author/" target="_blank" rel="noopener noreferrer">noahyz</a></span><span property="author" content="noahyz"></span></span><!----><!----><!----><!----><span class="page-word-info" aria-label="字数🔠" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 3248 字</span><meta property="wordCount" content="3248"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 11 分钟</span><meta property="timeRequired" content="PT11M"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#操作硬盘">操作硬盘</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#一、硬盘相关概念">一、硬盘相关概念</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#二、操作硬盘的方法">二、操作硬盘的方法</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#三、让-mbr-使用硬盘">三、让 MBR 使用硬盘</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h2 id="操作硬盘" tabindex="-1"><a class="header-anchor" href="#操作硬盘"><span>操作硬盘</span></a></h2><p>如下为机械硬盘</p><figure><img src="/assets/%E6%9C%BA%E6%A2%B0%E7%A1%AC%E7%9B%98%E7%A4%BA%E6%84%8F%E5%9B%BE-Df15Kr-s.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="一、硬盘相关概念" tabindex="-1"><a class="header-anchor" href="#一、硬盘相关概念"><span>一、硬盘相关概念</span></a></h3><p>CPU 通过 IO 接口与硬盘通信，针对硬盘的 IO 接口是“硬盘控制器”。硬盘控制器和硬盘是连接在一起的，是专门驱动硬盘设备的模块电路。这种接口也称为集成设备电路（Integrated Drive Electronics，IDE）。后来，又将此接口使用的技术规范归纳成全球硬盘标准，于是产生了 ATA（Advanced Technology Attachment）。硬盘串行接口称为（Serial ATA，SATA），硬盘并行接口称为（Parallel ATA，PATA）。</p><p>PATA 接口的线缆称为 IDE 线，一个 IDE 线上可以挂两块硬盘，一个是主盘（Master）、一个从盘（Slave）。现代的主盘和从盘之间的区别不明显了。主板上提供两个 IDE 插槽，分别位 IDE0 和 IDE1。支持 4 块 IDE（PATA）硬盘。</p><p>按照 ATA 标准，这两个插槽称为“通道”，IDE0 称为 Primary 通道，IDE1 称为 Secondary 通道。也就是说，每个通道上分别有主盘和从盘。</p><p>让硬盘工作，需要通过读写硬盘控制器的端口，端口就是位于 IO 控制器上的寄存器，此处就是硬盘控制器上的寄存器。</p><p>如下是硬盘控制器主要端口寄存器：</p><figure><img src="/assets/%E7%A1%AC%E7%9B%98%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%BB%E8%A6%81%E7%AB%AF%E5%8F%A3%E5%AF%84%E5%AD%98%E5%99%A8-AyP5R3OH.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>端口分为两种，<code>Command Block registers</code> 用于向硬盘驱动器写入命令字或者从硬盘控制器获取硬盘状态。<code>Control Block registers</code> 用于控制硬盘工作状态。</p><p>下面重点介绍下 <code>Command Block registers</code> 组的寄存器。</p><ul><li>端口是按照通道给出的，一个通道上有主、从两块硬盘。想要操作某通道上的某块硬盘，需要通过寄存器指定。device 寄存器的第4 位用于指定通道上的主、从硬盘，0 位主盘，1 位从盘。</li><li>data 寄存器（16 位）负责管理数据，作用是读取或者写入数据。 <ul><li>在读硬盘时，硬盘准备好数据后，硬盘控制器便将其放在内部的缓冲区中，不断读此寄存器便是读出缓冲区中的全部数据。</li><li>在写硬盘时，我们要把数据源源不断的输送到此端口，数据被存入缓冲区里，硬盘控制器发现这个缓冲区中有数据了，便将此处的数据写入相应的扇区。</li></ul></li><li>err / features 寄存器（8 位），他两是一个寄存器。 <ul><li>在读取硬盘时，称为 err 寄存器，失败时有用，里面会记录失败的信息。</li><li>在写硬盘时，称为 features 寄存器，有些命令需要指定额外参数，这些参数就写在 feature 寄存器中。</li></ul></li><li>sector count 寄存器（8 位），用来指定待读取或待写入的扇区数。硬盘每完成一个扇区，就会将此寄存器的值减 1。如果中间失败了，此寄存器中值是尚未操作的扇区。8 位最大值为 255，如果指定为 0，表示要操作 256 个扇区。</li></ul><p>LBA（Logical Block Address）是一种逻辑上为扇区编址的方法，全称为逻辑块地址。LBA 有两种，一种是 LBA28，有 28 位，最大支持 <code>pow(2, 28) </code> 个扇区，每个扇区 512 字节，最大支持 128 GB。另外一种是 LBA48，有 48 位，最大支持 <code>pow(2, 48)</code> 个扇区，最大支持 128 PB。我们采用 LBA28 模式。</p><p>LBA 寄存器，有 LBA low、LBA mid、LBA high 三个，都是 8 位宽度的。分别存储 LBA 28 位地址的 <code>0 - 7</code> 位、<code>8 - 15</code> 位、<code>16 - 23</code> 位。剩余的 4 位使用 device 寄存器。</p><ul><li><p>device 寄存器（8 位），低 4 位（0 - 3 位）存储 LBA 地址的低 <code>24 - 27</code> 位。第 4 位指定通道上的主盘或从盘，0代表主盘，1 代表从盘。第 6 位用来设置是否启用 LBA 方式，1 代表启用 LBA 模式，0 代表启用 CHS 模式。另外的第 5 位和第 7 位固定为 1，称为 MBS 位，不用管。</p><img src="/assets/device%E5%AF%84%E5%AD%98%E5%99%A8-DQeiBgZP.png" style="zoom:50%;"></li><li><p>status 寄存器（8 位），用在在读硬盘时，表示硬盘的状态信息。</p><ul><li>第 0 位是 ERR 位，如果此位为 1，表示出错，具体原因可见 err 寄存器。</li><li>第 3 位是 data request 位，如果此位为 1，表示硬盘已经把数据准备好了，主机现在可以把数据读取出来。</li><li>第 6 位是 DRDY 位，表示硬盘就绪，此位是在对硬盘诊断时用的，表示硬盘检测正常，可以继续执行一些命令</li><li>第 7 位是 BSY 位，表示硬盘是否繁忙，如果为 1 表示硬盘正忙着</li><li>其他位都无效，不用关注</li></ul><img src="/assets/status%E5%AF%84%E5%AD%98%E5%99%A8-rt31CxrI.png" style="zoom:50%;"></li><li><p>command 寄存器（8 位），command 寄存器和 status 寄存器是同一个寄存器。command 用在写硬盘时，用来存储让硬盘执行的命令，只要把命令写进此寄存器，硬盘就开始工作了。如下主要使用的三个命令</p><ul><li>identify：0xEC，即硬盘识别</li><li>read sector：0x20，即读扇区</li><li>write sector：0x30，即写扇区</li></ul><p>其中 identify 命令是获取硬盘的信息，用于获取硬盘的参数，此命令的返回结果是以字为单位。如下是返回信息：</p><ul><li>字偏移量（10 - 19）：硬盘序列号，长度为 20 的字符串</li><li>字偏移量（27 - 46）：硬盘型号，长度为 40 的字符串</li><li>字偏移量（60 - 61）：可供用户使用的扇区数，长度为 2 的整型</li></ul></li></ul><h3 id="二、操作硬盘的方法" tabindex="-1"><a class="header-anchor" href="#二、操作硬盘的方法"><span>二、操作硬盘的方法</span></a></h3><p>最主要的顺序是 command 寄存器一定得是最后写，因为一旦 command 寄存器被写入后，硬盘就开始工作了。如下我们约定一个顺序：</p><ol><li>先选择通道，往该通道的 sector count 寄存器中写入待操作的扇区数</li><li>往该通道上的三个 LBA 寄存器写入扇区起始地址的低 24 位</li><li>往 device 寄存器中写入 LBA 地址的 <code>24 - 27</code> 位，并置第 6 位为 1，使其为 LBA 模式，设置第 4 位，选择操作的硬盘（master 硬盘或 slave 硬盘）</li><li>往该通道上的 command 寄存器写入操作命令</li><li>读取该通道上的 status 寄存器，判断硬盘工作是否完成</li><li>如果以上步骤是读硬盘，进入下一个步骤。否则，完工</li><li>即那个硬盘数据读出</li></ol><p>硬盘工作完成，他已经准备好了数据，获取的方式如下几种：</p><ul><li>无条件传送方式</li><li>查询传送方式</li><li>中断传送方式</li><li>直接存储器存取方式（DMA）</li><li>I/O 处理机传送方式</li></ul><p>第一种无条件传送方式，数据源设备一定是随时准备好了数据，CPU 随时取、随时拿都没有问题，如寄存器、内存等设备，CPU 取数据不用提前打招呼</p><p>第二种查询传送方式，也称为 PIO 或程序 IO（ Programming Input/Output Model ）。传输前由程序先去检测设备的状态。数据源设备在一定条件下才能传送数据。CPU 需要数据时，先去检查该设备的状态，如果状态为准备好了，才能获取数据。硬盘中有 status 寄存器，存储了工作状态。这类数据通常是低速设备。这种方式需要 CPU 不断查询设备状态，只有最后一次的查询才是有意义的，效率低。</p><p>第三种中断传送方式，也称为中断驱动 IO。当数据源设备准备好数据后，通过发中断来通知 CPU 来拿数据。但中断方式下的 CPU 需要通过压栈来保护现场，还要执行传输指令，最后还要恢复现场。因此还有更高效的方案。</p><p>第四种直接存储器存取方式（DMA），不让 CPU 参与传输，完全由数据源设备和内存直接传输，CPU 直接从内存中拿数据即可。DMA 是由硬件实现，需要 DMA 控制才可以。此方式中，在数据输入之后或输出之前还是有一部分工作要由 CPU 来完成，如数据交换、组合、校验等。</p><p>第五种 IO 处理机传送方式，又引入了新的硬件：IO 处理机。专门用于处理 IO，也是一种处理器，只不过用的是另一套擅长 IO 的指令系统，随时可以处理数据。有了 IO 处理机的帮助，CPU 甚至可以不知道有传输这回事。</p><p>我们当前的系统使用第 2 、3 种方式来学习。</p><h3 id="三、让-mbr-使用硬盘" tabindex="-1"><a class="header-anchor" href="#三、让-mbr-使用硬盘"><span>三、让 MBR 使用硬盘</span></a></h3><p>使用 <code>xchg bx, bx</code> 进行 bochs 下断点调试</p><p>首先来看看头文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>; loader 和 kernel</span></span>
<span class="line"><span>LOADER_BASE_ADDR equ 0x900</span></span>
<span class="line"><span>LOADER_START_SECTOR equ 0x2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如下是 <code>mbr.s</code> 的实现：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>%include &quot;boot.inc&quot;</span></span>
<span class="line"><span>SECTION MBR vstart=0x7c00</span></span>
<span class="line"><span>mov ax, cs</span></span>
<span class="line"><span>mov ds, ax</span></span>
<span class="line"><span>mov es, ax</span></span>
<span class="line"><span>mov ss, ax</span></span>
<span class="line"><span>mov fs, ax</span></span>
<span class="line"><span>mov sp, 0x7c00</span></span>
<span class="line"><span>mov ax, 0xb800</span></span>
<span class="line"><span>mov gs, ax </span></span>
<span class="line"><span></span></span>
<span class="line"><span>; 清屏</span></span>
<span class="line"><span>mov ax, 0x600</span></span>
<span class="line"><span>mov bx, 0x700</span></span>
<span class="line"><span>mov cx, 0</span></span>
<span class="line"><span>mov dx, 0x184f</span></span>
<span class="line"><span></span></span>
<span class="line"><span>int 0x10</span></span>
<span class="line"><span></span></span>
<span class="line"><span>; 操作显存</span></span>
<span class="line"><span>mov byte [gs:0x00], &#39;I&#39;</span></span>
<span class="line"><span>mov byte [gs:0x01], 0x9F</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x02], &#39; &#39;</span></span>
<span class="line"><span>mov byte [gs:0x03], 0x9F</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x04], &#39;M&#39;</span></span>
<span class="line"><span>mov byte [gs:0x05], 0x9F</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x06], &#39;B&#39;</span></span>
<span class="line"><span>mov byte [gs:0x07], 0x9F</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x08], &#39;R&#39;</span></span>
<span class="line"><span>mov byte [gs:0x09], 0x9F</span></span>
<span class="line"><span></span></span>
<span class="line"><span>xchg bx, bx</span></span>
<span class="line"><span></span></span>
<span class="line"><span>; 起始扇区 LBA 地址</span></span>
<span class="line"><span>mov eax, LOADER_START_SECTOR</span></span>
<span class="line"><span>; 写入的地址</span></span>
<span class="line"><span>mov bx, LOADER_BASE_ADDR</span></span>
<span class="line"><span>; 待读入的扇区数</span></span>
<span class="line"><span>mov cx, 1</span></span>
<span class="line"><span>; 读取程序的起始部分</span></span>
<span class="line"><span>call rd_disk_m_16</span></span>
<span class="line"><span></span></span>
<span class="line"><span>jmp LOADER_BASE_ADDR</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>; 读取硬盘的 N 个扇区</span></span>
<span class="line"><span>rd_disk_m_16:</span></span>
<span class="line"><span>    ; 备份 eax</span></span>
<span class="line"><span>    mov esi, eax</span></span>
<span class="line"><span>    ; 备份 cx</span></span>
<span class="line"><span>    mov di, cx</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; 如下为读写硬盘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; 第一步：设置要读取的扇区数</span></span>
<span class="line"><span>    mov dx, 0x1f2</span></span>
<span class="line"><span>    mov al, cl </span></span>
<span class="line"><span>    out dx, al   ; 设置要读取的扇区数</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    mov eax, esi  ; 恢复 ax</span></span>
<span class="line"><span>    </span></span>
<span class="line"><span>    ; 第二步：将 LBA 地址存入 0x1f3 - 0x1f6</span></span>
<span class="line"><span>    ; LBA 地址 7 - 0 位写入端口 0x1f3</span></span>
<span class="line"><span>    mov dx, 0x1f3</span></span>
<span class="line"><span>    out dx, al </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; LBA 地址 15 - 8 位写入端口 0x1f4</span></span>
<span class="line"><span>    mov cl, 8</span></span>
<span class="line"><span>    shr eax, cl</span></span>
<span class="line"><span>    mov dx, 0x1f4 </span></span>
<span class="line"><span>    out dx, al </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; LBA 地址 23 - 16 位写入端口 0x1f5</span></span>
<span class="line"><span>    shr eax, cl </span></span>
<span class="line"><span>    mov dx, 0x1f5</span></span>
<span class="line"><span>    out dx, al </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; LBA 地址 27 - 24 位写入端口 0x1f6</span></span>
<span class="line"><span>    ; 要使用 device 寄存器</span></span>
<span class="line"><span>    shr eax, cl </span></span>
<span class="line"><span>    and al, 0x0f  ; 只使用 al 的低 4 位用于 LBA 地址的 27 - 24 位</span></span>
<span class="line"><span>    ; 设置 device 寄存器的 7 - 4 位</span></span>
<span class="line"><span>    ; 第 5 、7 位固定为 1，第 6 位表示寻址模式，LBA:1, CHS:0</span></span>
<span class="line"><span>    ; 第 4 位表示主盘(0)还是从盘(0)</span></span>
<span class="line"><span>    or al, 0xe0</span></span>
<span class="line"><span>    mov dx, 0x1f6</span></span>
<span class="line"><span>    out dx, al </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; 第三步：向 0x1f7 端口写入读命令，0x20</span></span>
<span class="line"><span>    mov dx, 0x1f7</span></span>
<span class="line"><span>    mov al, 0x20</span></span>
<span class="line"><span>    out dx, al</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; 第四步：检测硬盘状态</span></span>
<span class="line"><span>    .not_ready:</span></span>
<span class="line"><span>    		; 空操作，为了增加延时</span></span>
<span class="line"><span>        nop</span></span>
<span class="line"><span>        ; 从 0x1f7 端口读信息，读到 al 寄存器中</span></span>
<span class="line"><span>        ; 0x1f7 端口在读的时候，对应的 status 寄存器中，第 3 位为 1 表示准备好数据，可以输出，第 7 位为 1 表示磁盘正忙</span></span>
<span class="line"><span>        in al, dx </span></span>
<span class="line"><span>        and al, 0x88</span></span>
<span class="line"><span>        cmp al, 0x08</span></span>
<span class="line"><span>        ; jnz 检测前一个操作的结果，如果非 0，则跳转</span></span>
<span class="line"><span>        jnz .not_ready</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ; 第 5 步：从 0x1f0 端口读数据</span></span>
<span class="line"><span>    ; di 中是备份的 cx，也就是要读取的扇区数</span></span>
<span class="line"><span>    mov ax, di </span></span>
<span class="line"><span>    ; 一个扇区有 512 字节，所以读入一个字，需要 (di * 512 / 2) 次</span></span>
<span class="line"><span>    mov dx, 256</span></span>
<span class="line"><span>    ; mul 指令将源操作数和 ax 寄存器中值相乘，结果保存在 dx:ax 寄存器中</span></span>
<span class="line"><span>    mul dx </span></span>
<span class="line"><span>    mov cx, ax </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    mov dx, 0x1f0 </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    .go_on_read:</span></span>
<span class="line"><span>        in ax, dx </span></span>
<span class="line"><span>        ; 每次从 data 寄存器中读 2 字节，写到 bx 寄存器指向的内存；写一次给 bx 指向的位置加 2</span></span>
<span class="line"><span>        mov [bx], ax </span></span>
<span class="line"><span>        add bx, 2</span></span>
<span class="line"><span>        loop .go_on_read</span></span>
<span class="line"><span>        ret</span></span>
<span class="line"><span></span></span>
<span class="line"><span>times 510-($-$$) db 0</span></span>
<span class="line"><span>db 0x55, 0xaa</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如下是 <code>loader.s</code> 的实现：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>%include &quot;boot.inc&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>section loader vstart=LOADER_BASE_ADDR</span></span>
<span class="line"><span>mov ax, 0xb810</span></span>
<span class="line"><span>mov gs, ax </span></span>
<span class="line"><span></span></span>
<span class="line"><span>; 操作显存</span></span>
<span class="line"><span>mov byte [gs:0x00], &#39;2&#39;</span></span>
<span class="line"><span>mov byte [gs:0x01], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x02], &#39; &#39;</span></span>
<span class="line"><span>mov byte [gs:0x03], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x04], &#39;L&#39;</span></span>
<span class="line"><span>mov byte [gs:0x05], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x06], &#39;O&#39;</span></span>
<span class="line"><span>mov byte [gs:0x07], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x08], &#39;A&#39;</span></span>
<span class="line"><span>mov byte [gs:0x09], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x0a], &#39;D&#39;</span></span>
<span class="line"><span>mov byte [gs:0x0b], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x0c], &#39;E&#39;</span></span>
<span class="line"><span>mov byte [gs:0x0d], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mov byte [gs:0x0e], &#39;R&#39;</span></span>
<span class="line"><span>mov byte [gs:0x0f], 0xA4</span></span>
<span class="line"><span></span></span>
<span class="line"><span>jmp $</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中 bochs 的配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>megs: 32</span></span>
<span class="line"><span></span></span>
<span class="line"><span>romimage: file=&quot;/usr/local/share/bochs/BIOS-bochs-latest&quot;</span></span>
<span class="line"><span>vgaromimage: file=&quot;/usr/local/share/bochs/VGABIOS-lgpl-latest&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>boot: disk</span></span>
<span class="line"><span></span></span>
<span class="line"><span>log: bochs.out</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 增加此项，允许下断点调试</span></span>
<span class="line"><span>magic_break: enabled=1</span></span>
<span class="line"><span>display_library: x, options=&quot;gui_debug&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mouse: enabled=0</span></span>
<span class="line"><span># keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none</span></span>
<span class="line"><span># map=/usr/local/share/bochs/keymaps/x11-pc-us.map</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14</span></span>
<span class="line"><span>ata0-master: type=disk, path=&quot;a.img&quot;, mode=flat, cylinders=121, heads=16, spt=63</span></span>
<span class="line"><span></span></span>
<span class="line"><span># gdbstub: enabled=1, port=1234, text_base=0, data_base=0, bss_base=0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后是编译调试：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>nasm -o mbr.bin mbr.s</span></span>
<span class="line"><span>nasm -o loader.bin loader.s</span></span>
<span class="line"><span>dd if=mbr.bin of=a.img bs=512 count=1 conv=notrunc</span></span>
<span class="line"><span>dd if=loader.bin of=a.img bs=512 count=1 seek=2 conv=notrunc</span></span>
<span class="line"><span>bochs -q -f bochsrc_01.txt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于代码中的一些重要的部分解释如下：</p><ul><li>我们为什么需要备份 eax 寄存器呢？因为 al 在 out 指令中会用到</li><li>包括 cx 寄存器也需要备份，因为 cx 一般用在循环时</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span># 硬盘的配置</span></span>
<span class="line"><span>ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14</span></span>
<span class="line"><span>ata0-master: type=disk, path=&quot;a.img&quot;, mode=flat, cylinders=121, heads=16, spt=63</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上是硬盘的配置，我们的虚拟硬盘属于 ata0，是 Primary 通道，所以 sector count 寄存器是由 0x1f2 端口来访问。ata0-master 表明 <code>a.img</code> 是主盘。</p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><!----></div><!--]--><!--[--><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-D1zlwylF.js" defer></script>
  </body>
</html>
