<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.50" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://noahyz.github.io/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/2.%E6%8E%92%E6%9F%A5%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E7%9A%84%E5%8E%9F%E5%9B%A0.html"><meta property="og:site_name" content="noahyz的博客"><meta property="og:title" content="2.排查进程终止的原因"><meta property="og:description" content="最近线上遇到一个很抓狂的问题，线上跑的服务端进程突然没有了。虽然及时发现重启解决问题，但是必须要查查为什么进程没了。 1. 进程终止的原因 一共有 8 种方式让进程终止，其中有 5 种是正常终止 从 main 函数返回 调用 exit 调用 _exit 或者 _Exit 最后一个线程从其启动例程返回 从最后一个线程调用 pthread_exit 异常终..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="noahyz"><meta property="article:tag" content="进程丢失"><meta property="article:published_time" content="2020-10-25T19:11:41.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"2.排查进程终止的原因","image":[""],"datePublished":"2020-10-25T19:11:41.000Z","dateModified":null,"author":[{"@type":"Person","name":"noahyz","url":"/about-the-author/"}]}</script><meta name="robots" content="all"><meta name="author" content="noahyz"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="keywords" content="Java, Java基础, 并发编程, JVM, 虚拟机, 数据库, MySQL, Spring, Redis, MyBatis, SpringBoot, IDEA, 求职面试, 面渣逆袭, 学习路线"><meta name="apple-mobile-web-app-capable" content="yes"><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?5230ac143650bf5eb3c14f3fb9b1d3ec";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      </script><script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?59aa453e7e706422c636c079fc1cb031";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      </script><link rel="stylesheet" href="//at.alicdn.com/t/font_3180624_7cy10l7jqqh.css"><link rel="icon" href="/logo2.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#096dd9"><title>2.排查进程终止的原因 | noahyz的博客</title><meta name="description" content="最近线上遇到一个很抓狂的问题，线上跑的服务端进程突然没有了。虽然及时发现重启解决问题，但是必须要查查为什么进程没了。 1. 进程终止的原因 一共有 8 种方式让进程终止，其中有 5 种是正常终止 从 main 函数返回 调用 exit 调用 _exit 或者 _Exit 最后一个线程从其启动例程返回 从最后一个线程调用 pthread_exit 异常终...">
    <link rel="preload" href="/assets/style-D4RaGlXo.css" as="style"><link rel="stylesheet" href="/assets/style-D4RaGlXo.css">
    <link rel="modulepreload" href="/assets/app-D1zlwylF.js"><link rel="modulepreload" href="/assets/2.排查进程终止的原因.html-dwZugBzW.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/./logo.png" alt><!----><span class="vp-site-name hide-in-pad">noahyz的博客</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="知识库"><!--[--><span class="font-icon icon iconfont icon-lujing" style=""></span><!--]-->知识库<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">编程语言</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">操作系统</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">进程管理</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">内存管理</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">文件管理</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">CPU管理</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">问题排查</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/1.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.html" aria-label="1.多进程的死锁问题"><!---->1.多进程的死锁问题<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/2.%E6%8E%92%E6%9F%A5%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2%E7%9A%84%E5%8E%9F%E5%9B%A0.html" aria-label="2.排查进程终止的原因"><!---->2.排查进程终止的原因<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/3.linux%E4%B8%8B%E6%AE%B5%E9%94%99%E8%AF%AF%E7%9A%84%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95.html" aria-label="3.linux下段错误的产生原因及调试方法"><!---->3.linux下段错误的产生原因及调试方法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/4.load%E4%B8%8D%E5%88%B0%E5%85%B1%E4%BA%AB%E5%BA%93.html" aria-label="4.load不到共享库"><!---->4.load不到共享库<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">系统编程</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">计算机网络</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">技术专题</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">架构框架</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">分布式</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->2.排查进程终止的原因</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="/about-the-author/" target="_blank" rel="noopener noreferrer">noahyz</a></span><span property="author" content="noahyz"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2020-10-25T19:11:41.000Z"></span><!----><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color5 clickable" role="navigation">进程丢失</span><!--]--><meta property="keywords" content="进程丢失"></span><span class="page-word-info" aria-label="字数🔠" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 1840 字</span><meta property="wordCount" content="1840"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 6 分钟</span><meta property="timeRequired" content="PT6M"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_1-进程终止的原因">1. 进程终止的原因</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_2-信号">2. 信号</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#_3-谁发的信号">3.谁发的信号</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><p>最近线上遇到一个很抓狂的问题，线上跑的服务端进程突然没有了。虽然及时发现重启解决问题，但是必须要查查为什么进程没了。</p><h2 id="_1-进程终止的原因" tabindex="-1"><a class="header-anchor" href="#_1-进程终止的原因"><span>1. 进程终止的原因</span></a></h2><p>一共有 8 种方式让进程终止，其中有 5 种是正常终止</p><ol><li>从 main 函数返回</li><li>调用 exit</li><li>调用 _exit 或者 _Exit</li><li>最后一个线程从其启动例程返回</li><li>从最后一个线程调用 pthread_exit</li></ol><p>异常终止有 3 种</p><ol><li>调用 abort</li><li>接到一个信号</li><li>最后一个线程对取消请求作出响应</li></ol><p>我们跑在线上的服务进程都是不会退出的，正常情况下业务是不会让其退出的。在上面说到的异常情况中，没有业务会去主动调用 abort 函数，其实调用 abort 就是发送进程不可忽略的信号 SIGABRT 信号。最后一个线程对取消请求作出响应这种情况业务一般也不会自己设置。因此经过排查，<strong>其实线上的服务进程终止就只能是收到了一个信号，要么是这个信号进程没有处理执行了默认退出的动作，要么是进程本身不具备处理这个信号的权限。</strong></p><p>其中有两个信号比较特殊，SIGKILL、SIGSTOP。这两个信号不能被忽略，因为他们向内核和超级用户提供了使进程终止或者停止的可靠方法。这两个信号也不能捕捉。还有一类信号例如：SIGABRT、SIGBUS等，虽然可以捕捉甚至忽略，但是通常不建议这么干，由硬件异常产生的信号(如非法内存引用或者除以0，甚至硬件故障) ，进程继续运行的行为是未知的。</p><p>而重点是我们需要知道这个信号是其他进程发出的，还是自己给自己发出的退出信号。</p><p><strong>因此，我们现在很清楚，解决进程悄无声息的终止的原因，就是进程收到了一个让其退出的信号，找到谁发的这个信号，然后弄清楚它为什么要发。</strong></p><h2 id="_2-信号" tabindex="-1"><a class="header-anchor" href="#_2-信号"><span>2. 信号</span></a></h2><p>我们经常使用的 kill ，起始就是给进程发送信号 SIGKILL 。再比如写 c++ 程序最常遇到的段错误，就是内核给进程发送了例如 SIGSEGV 信号，代表无效的内存引用。</p><p>举个例子：</p><div class="language-c++ line-numbers-mode" data-highlighter="shiki" data-ext="c++" data-title="c++" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> &lt;unistd.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">	while</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">		sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我写了一段代码，然后编译，放在后台运行，并且使用 strace 查看监控该进程。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>gcc -o test test.c</span></span>
<span class="line"><span>./test &amp;  //得到该进程的pid</span></span>
<span class="line"><span>strace -T -tt -e trace=all -p process_pid</span></span>
<span class="line"><span>然后另起终端，kill 掉这个进程。 kill -9 process_id</span></span>
<span class="line"><span>观察 strace 的状态</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>09:31:30.821272 +++ killed by SIGKILL +++</span></span>
<span class="line"><span>[1]+  已杀死               ./test</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>最后显示出两行信息，收到了 SIGKILL 信号，于是进程默认退出了。好，明白了信号的简单原理。我们再来探究一个问题，此时我们虽然知道了收到了那个信号。但是不知道谁发的这个信号，还有他为什么要发这个信号。接下来我们探究一下原因。</p><h2 id="_3-谁发的信号" tabindex="-1"><a class="header-anchor" href="#_3-谁发的信号"><span>3.谁发的信号</span></a></h2><p>先来介绍一种非常常见的系统性问题引起的 kill 掉进程。</p><h4 id="_3-1-系统-oom" tabindex="-1"><a class="header-anchor" href="#_3-1-系统-oom"><span>3.1 系统 OOM</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Major distribution kernels set the default value of /proc/sys/vm/overcommit_memory to zero, which means that processes can request more memory than is currently free in the system. This is done based on the heuristics that allocated memory is not used immediately, and that processes, over their lifetime, also do not use all of the memory they allocate. Without overcommit, a system will not fully utilize its memory, thus wasting some of it. Overcommiting memory allows the system to use the memory in a more efficient way, but at the risk of OOM situations. Memory-hogging programs can deplete the system&#39;s memory, bringing the whole system to a grinding halt. This can lead to a situation, when memory is so low, that even a single page cannot be allocated to a user process, to allow the administrator to kill an appropriate task, or to the kernel to carry out important operations such as freeing memory. In such a situation, the OOM-killer kicks in and identifies the process to be the sacrificial lamb for the benefit of the rest of the system.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Users and system administrators have often asked for ways to control the behavior of the OOM killer. To facilitate control, the /proc/&lt;pid&gt;/oom_adj knob was introduced to save important processes in the system from being killed, and define an order of processes to be killed. The possible values of oom_adj range from -17 to +15. The higher the score, more likely the associated process is to be killed by OOM-killer. If oom_adj is set to -17, the process is not considered for OOM-killing.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>linux 系统为了充分利用内存，在进程启动时，系统不会立即分配给进程内存，而是等进程需要内存的时候再来分配。换句话说，如果进程在启动时系统就分配好进程需要的内存，那么好处是：我们可以实时知道系统内存被使用了多少，后面启动的进程如果系统内存不足就不能启动。但是坏处是：系统分配给进程的内存可能进程暂时没有用到，让这块内存空闲着，浪费系统资源。于是才用进程先启动，等使用内存的时候再来分配。这就导致了占用内存的进程可能会耗尽系统的内存，使整个系统陷入停顿；而且这个行为是不可预知的，当系统内存被耗尽的时候，Linux 会采用 OOM-KILL 的方法，根据 oom_adj 来 kill 掉一个或多个进程，保证整个系统的稳定。(也有书上说，发生OOM 的时候会kill 掉占用内存最大的进程，源码没看，后面看了补上)</p><p>这是一种常见的进程被系统干掉的例子，如果出现这种情况，一般会在 /var/log 下的 message、syslog 或其他文件中留下痕迹，也可以使用 dmesg 来查看</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>dmesg -T | grep -E -i -B100 &#39;killed process&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>因此，建议如果是比较重要的进程，那么就给这个进程以保护机制，就如上面提到的设置 oom_adj，oom_adj 的值为 -17---+15，值越大发生OOM 的时候更容易被 kill 掉，如果某个进程 oom_adj 设置为 -17，那么就说明这个进程就被认为是不能被 OOM-killing 的。</p><h4 id="_3-2-查看日志" tabindex="-1"><a class="header-anchor" href="#_3-2-查看日志"><span>3.2 查看日志</span></a></h4><p>last 可以看到谁登陆到了系统，history 可以看到系统的操作记录。</p><p>工具 systemtap 是一款内核调试工具，几乎可以监控任何系统调用。</p><p>工具 audit 可以详细监控用户的行为，详细到查看或修改了某个文件。这些都可以在日志中查看到。</p><p>这两个工具后续会补上其使用方法</p><h4 id="_3-3-其他思路" tabindex="-1"><a class="header-anchor" href="#_3-3-其他思路"><span>3.3 其他思路</span></a></h4><p>再执行 linux 命令或者执行脚本的时候一定要清楚脚本或者命令的作用，例如：下面</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>kill -9 `ps aux | grep python | awk &#39;{print $2}&#39;`</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>杀掉了所有的 python 进程</p><p>比如 top -c 默认按照 CPU 使用量排序，所以CPU 100% 的进程在最前面，当按下 K 键时就给进程发了信号，默认信号是 SIGTERM（15），而且history 看日志的时候也只是一个 top 命令。</p><p>还有看看定时事件 crontab，是否有定时事件在搞鬼。</p><p>参考博文：<a href="https://www.cnblogs.com/xybaby/p/8098229.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/xybaby/p/8098229.html</a></p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/1.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.html" aria-label="1.多进程的死锁问题"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->1.多进程的死锁问题</div></a><a class="route-link auto-link next" href="/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/3.linux%E4%B8%8B%E6%AE%B5%E9%94%99%E8%AF%AF%E7%9A%84%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0%E5%8F%8A%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95.html" aria-label="3.linux下段错误的产生原因及调试方法"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">3.linux下段错误的产生原因及调试方法<!----></div></a></nav><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><!----></div><!--]--><!--[--><!----><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-D1zlwylF.js" defer></script>
  </body>
</html>
